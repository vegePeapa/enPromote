# 纵向滚动关卡地图系统部署指南

## 系统更新概述

本次更新实现了纵向滚动的关卡地图系统，主要特性：

✅ **纵向滚动关卡地图** - 用户可以向上滑动查看历史关卡，向下查看未来章节
✅ **自动场景适配** - AI对话自动根据用户当前章节选择对应场景提示词
✅ **未解锁章节限制** - 未解锁章节只显示第一关（单词学习），其他关卡隐藏
✅ **完整的数据库支持** - 用户进度、章节数据完整迁移
✅ **前后端接口优化** - API自动检测用户章节，无需前端传递参数

## 快速部署步骤

### 1. 数据库迁移（重要！）

```bash
# 进入服务器目录
cd server

# 运行数据迁移脚本（将现有用户数据迁移到新章节系统）
node scripts/migrateToChapters.js
```

### 2. 安装依赖

```bash
# 后端依赖
cd server
npm install

# 前端依赖
cd ../en_ui
npm install
```

### 3. 启动服务

```bash
# 启动后端服务
cd server
npm start

# 启动前端服务（新终端）
cd en_ui
npm run dev
```

## 主要更新内容

### 🔧 后端更新

1. **AI路由优化** (`server/router/ai.js`)
   - `ai_generate_question` 接口现在自动根据用户当前章节选择AI提示词
   - 添加了用户认证和错误处理
   - 返回章节信息供前端使用

2. **用户认证完善** (`server/router/auth.js`)
   - `switch-chapter` 接口支持章节切换
   - `info` 接口返回完整的章节进度信息
   - 自动初始化新用户的章节数据

3. **数据模型支持** (`server/modules/User.js`, `server/modules/Word.js`)
   - User模型已支持多章节进度跟踪
   - Word模型包含章节和场景字段
   - 完整的向后兼容性

### 🎨 前端更新

1. **新增纵向关卡地图** (`en_ui/src/views/AdventureMap.vue`)
   - 纵向滚动的关卡布局
   - 历史关卡、当前关卡、未来章节的清晰展示
   - 响应式设计，支持移动端

2. **路由更新** (`en_ui/src/router/router.ts`)
   - `/adventure` 路由现在指向新的 `AdventureMap.vue`
   - 保持了原有的章节选择页面 `/chapters`

3. **API类型定义** (`en_ui/src/api/auth.ts`)
   - 更新了 `UserInfo` 接口，包含章节相关字段
   - 完善的TypeScript类型支持

## 功能验证清单

部署完成后，请验证以下功能：

- [ ] 用户登录后能看到章节选择页面
- [ ] 章节选择页面显示正确的进度信息
- [ ] 点击章节后跳转到纵向滚动的关卡地图
- [ ] 关卡地图正确显示：
  - [ ] 历史完成的关卡（向上滑动查看）
  - [ ] 当前章节的关卡状态（已完成/当前/锁定）
  - [ ] 未解锁章节只显示第一关
- [ ] AI对话自动适应当前章节场景
- [ ] 关卡点击能正确跳转到对应功能页面

## 故障排除

### 常见问题

1. **数据迁移失败**
   ```bash
   # 检查数据库连接
   # 确保 MongoDB 服务正在运行
   # 检查 server/scripts/migrateToChapters.js 中的数据库连接字符串
   ```

2. **前端页面空白**
   ```bash
   # 检查控制台错误
   # 确保所有依赖已正确安装
   # 检查 API 接口是否正常响应
   ```

3. **章节切换不生效**
   ```bash
   # 检查用户是否已登录
   # 验证 /auth/switch-chapter 接口响应
   # 检查用户数据是否正确迁移
   ```

## 后续扩展

系统已为未来扩展做好准备：

- 🎯 **新章节添加** - 只需在 `server/config/chapters.js` 中添加配置
- 🎮 **新关卡类型** - 可轻松扩展关卡类型和游戏机制
- 🏆 **成就系统** - 基础数据结构已支持成就和徽章
- 👥 **社交功能** - 可添加好友进度对比等功能

## 技术支持

如遇到问题，请检查：
1. 服务器日志 (`server/logs/`)
2. 浏览器控制台错误
3. 数据库连接状态
4. API接口响应

---

🎉 **恭喜！** 你的英语学习网站现在拥有了全新的纵向滚动关卡地图系统！